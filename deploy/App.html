<!DOCTYPE html>
<html>
<head>
    <title>Defect Trend App</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>



    <script type="text/javascript">
        Rally.onReady(function () {
(function() {
  var allFilters, projectFilter, stateFilters, typeFilter;

  Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    launch: function() {
      return this.createColumnGrid();
    },
    xAxisDataTransformer: function(snapshots) {
      var data;
      data = [].each(snapshots, function(snapshot) {
        return data.push(Date.parse(snapshot.data._ValidFrom));
      });
      return data;
    },
    createColumnGrid: function() {}
  }, typeFilter = Ext.create('Rally.data.lookback.QueryFilter', {
    property: '_TypeHierarchy',
    operator: '=',
    value: 'HierarchicalRequirement'
  }), projectFilter = Ext.create('Rally.data.lookback.QueryFilter', {
    property: '_ProjectHierarchy',
    operator: '=',
    value: 11985641446
  }), stateFilters = Rally.data.lookback.QueryFilter.and([
    {
      property: '_PreviousValues.ScheduleState',
      operator: '<',
      value: 'Accepted'
    }, {
      property: 'ScheduleState',
      operator: '>=',
      value: 'Accepted'
    }
  ]).or({
    property: 'ScheduleState',
    operator: '=',
    value: 'Idea'
  }), allFilters = projectFilter.and(typeFilter.and(stateFilters)), this.columnChart = Ext.create('Rally.ui.chart.Chart', {
    storeType: 'Rally.data.lookback.SnapshotStore',
    storeConfig: {
      hydrate: ["ScheduleState"],
      fetch: ["_ValidFrom", "_ValidTo", "ObjectID", "ScheduleState"],
      filters: allFilters
    },
    calculatorType: 'CustomChartCalculator',
    calculatorConfig: {},
    chartConfig: {
      chart: {
        zoomType: 'x',
        type: 'column'
      },
      title: {
        text: 'Changed Defects over Time'
      },
      xAxis: {},
      yAxis: {
        title: {
          text: 'Number of Changed Defects'
        }
      }
    }
  }), this.add(this.columnChart), {
    createTrendGrid: function() {
      Ext.define('My.TrendCalc', {
        extend: 'Rally.data.lookback.calculator.TimeSeriesCalculator',
        getMetrics: function() {
          return [
            {
              as: 'Defects',
              display: 'line',
              f: 'count'
            }
          ];
        }
      });
      this.myTrendChart = Ext.create('Rally.ui.chart.Chart', {
        storeType: 'Rally.data.lookback.SnapshotStore',
        storeConfig: {
          find: {
            _TypeHierarchy: "Defect",
            State: {
              $in: ["Open", "Submitted"]
            }
          },
          hydrate: ["Priority"],
          fetch: ["_ValidFrom", "_ValidTo", "ObjectID", "Priority"]
        },
        calculatorType: 'My.TrendCalc',
        calculatorConfig: {},
        chartConfig: {
          chart: {
            zoomType: 'x',
            type: 'line'
          },
          title: {
            text: 'Defects over Time'
          },
          xAxis: {},
          yAxis: {
            title: {
              text: 'Number of Defects'
            }
          }
        }
      });
      return this.add(this.myTrendChart);
    }
  });

}).call(this);

(function() {
  var Ext;

  Ext = window.Ext4 || window.Ext;

  Ext.define('CustomChart', {
    extend: 'Rally.ui.chart.Chart',
    _haveDataToRender: function() {
      return true;
    },
    _getChart: function() {
      return this.down('highchart');
    },
    _getChartData: function() {
      return this.calculator.prepareChartData(this.loadedStores);
    },
    getTotalPoints: function() {
      return this.chartData.series[0].data.length;
    },
    _clearData: function() {
      var chart;
      chart = this._getChart().chart;
      while (chart.series.length) {
        chart.series[0].remove(false);
      }
    },
    updateData: function() {
      var chart, series, _i, _len, _ref;
      this.chartData = this._getChartData();
      this._clearData();
      chart = this._getChart().chart;
      _ref = this.chartData.series;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        series = _ref[_i];
        chart.addSeries(series, false);
      }
      chart.redraw();
      return this.fireEvent('chartRendered', this);
    },
    _renderChart: function() {
      Highcharts.setOptions(Ext.global["Highcharts" + this.themename + "Theme"]);
      return this.down('#chart').add({
        margin: 20,
        xtype: 'highchart',
        chartConfig: this.getChartConfig(),
        series: this.chartData.series
      });
    }
  });

}).call(this);

(function() {
  var Ext;

  Ext = window.Ext4 || window.Ext;

  Ext.define('CustomChartCalculator', {
    extend: 'Rally.data.lookback.calculator.BaseCalculator',
    mixins: {
      observable: "Ext.util.Observable"
    },
    constructor: function() {
      this.mixins.observable.constructor.call(this);
      this.callParent(arguments);
    },
    prepareChartData: function(store) {
      var snapshots;
      snapshots = store.data.items;
      return this.runCalculation(snapshots);
    },
    transformXdata: function(snapshotsByOid) {
      throw new Error('This method must be overridden');
    },
    transformYdata: function(snapshotsByOid) {
      throw new Error('This method must be overridden');
    },
    runCalculation: function(snapshots) {
      var chartData, closedSnapshots, closedxdata, firstDate, groupedSnapshots, lastDate, openedSnapshots, openxdata;
      firstDate = Date.UTC(snapshots[0].data._validFrom);
      lastDate = Date.UTC(snapshots[snapshots.lenth - 1].data._validTo);
      groupedSnapshots = _.groupBy(snapshots, function(snapshot) {
        return snapshot.ObjectID;
      });
      openedSnapshots = [];
      closedSnapshots = [];
      _.each(groupedSnapshots, function(snapshots, oid) {
        openedSnapshots.push(snapshots[0]);
        if (snapshots[snapshots.length - 1].data.ScheduleState !== "Idea") {
          return closedSnapshots.push(snapshots[snapshots.length - 1]);
        }
      });
      openxdata = this.transformXdata(openedSnapshots);
      closedxdata = this.transformXdata(closedSnapshots);
      chartData = {
        series: [
          {
            name: 'Open Defects',
            data: openxdata
          }, {
            name: 'Closed Defects',
            data: closedxdata
          }
        ]
      };
      return chartData;
    }
  });

}).call(this);

            
            Rally.launchApp('CustomApp', {
                name:"Defect Trend App",
                parentRepos:""
            });

        });
    </script>




    <style type="text/css">
.app {
     /* Add app styles here */
}

    </style>

</head>
<body></body>
</html>
